# GORM 模型生成规范

> 本文档定义 GORM 模型的生成规则，供 LLM 在生成模型代码时参考。

---

## 命名规范

- **表名**：小写字母 + 下划线，禁止大写和数字
- **字段名（列名）**：小写字母 + 下划线
- **Go 字段名**：大驼峰（PascalCase）
- **关联字段**：列名 `${entity}_id`，Go 字段名 `${Entity}ID`，如 `org_id` / `OrgID`
- **层级自关联**：列名 `pid`，Go 字段名 `PID`

---

## 基本结构

所有模型必须遵循以下结构模板：

```go
package model

import "time"

// EntityName 实体注释（来自思维导图）
type EntityName struct {
	ID        string    `gorm:"primaryKey;column:id;type:bigint"`
	CreatedAt time.Time `gorm:"column:created_at;type:timestamptz;not null;index"`
	UpdatedAt time.Time `gorm:"column:updated_at;type:timestamptz;not null"`
	// 业务字段按思维导图中的顺序排列...
	FieldName string `gorm:"column:field_name;type:text;not null;comment:字段注释"` // 字段注释（来自思维导图）
}

func (EntityName) TableName() string {
	return "entity_name"
}
```

---

## 注释规范

- **表注释**：在 `type` 声明上方添加 Go 注释，内容来自思维导图中的表/实体描述
- **字段注释**：在字段行尾添加 Go 注释，内容来自思维导图中的字段描述
- 注释必须保留思维导图中的原始描述，不得省略或修改

### 数据库注释（COMMENT）

GORM 模型必须使用 `comment` 标签为表和字段添加数据库级别的注释，便于数据库管理工具查看字段含义。

#### 字段注释
- 在 gorm tag 中添加 `comment:xxx` 标签
- 注释内容与 Go 行尾注释保持一致
- 示例：`gorm:"column:email;type:text;not null;uniqueIndex;comment:邮箱地址"`

#### 表注释
- 通过实现 `TableName()` 方法无法直接设置表注释
- 需要在迁移时使用 `Migrator().SetComment()` 或在迁移 SQL 中添加 `COMMENT ON TABLE`
- 推荐在 Atlas 迁移文件中统一管理表注释：
  ```sql
  COMMENT ON TABLE "user" IS '系统用户';
  ```

---

## 字段定义规则

### 主键
- 必须使用 `ID string` 作为主键（使用 `string` 是因为 JavaScript 无法安全处理超过 `Number.MAX_SAFE_INTEGER` 的整数）
- Tag 格式：`gorm:"primaryKey;column:id;type:bigint"`
- 数据库存储为 `bigint`，Go 层使用 `string` 自动转换

### 时间字段
- 必须包含 `CreatedAt` 和 `UpdatedAt`
- 类型：`time.Time`
- 必须显式指定 `type:timestamptz`（GORM 默认使用 `timestamp without time zone`，不符合规范）
- `CreatedAt` 必须添加 `index` 索引，用于按创建时间排序查询
- Tag 格式：
  - `CreatedAt`：`gorm:"column:created_at;type:timestamptz;not null;index"`
  - `UpdatedAt`：`gorm:"column:updated_at;type:timestamptz;not null"`

### 关联字段（逻辑外键）
- 命名格式：`${Entity}ID`，如 `OrgID`、`UserID`
- 类型：`string`（与主键保持一致，避免前端精度丢失）
- 列名格式：`${entity}_id`，如 `org_id`、`user_id`
- Tag 格式：`gorm:"column:org_id;type:bigint;not null"`
- 层级自关联使用 `PID string` + `gorm:"column:pid;type:bigint"`

### 文本字段
- 类型：`string`
- 必须显式指定 `type:text`
- 示例：`gorm:"column:name;type:text;not null"`

### 布尔字段
- 启用/禁用统一使用 `Active bool`
- 必须指定默认值：`gorm:"column:active;not null;default:true"`

### 状态字段
- 业务流转状态使用 `State int16`
- 状态值从 1 开始，负值表示异常

### 排序字段
- 使用 `Sort int16`
- 默认值为 0：`gorm:"column:sort;not null;default:0"`

### JSONB 字段
- 对象类型：使用 `common.M`（`map[string]any`）
- 数组类型：使用 `common.A`（`[]any`），适用于数组或数组对象
- Tag 格式：`gorm:"column:xxx;type:jsonb;not null;default:'{}'"`（对象）或 `default:'[]'`（数组）
- 示例：
  ```go
  Metadata common.M `gorm:"column:metadata;type:jsonb;not null;default:'{}'"`
  Tags     common.A `gorm:"column:tags;type:jsonb;not null;default:'[]'"`
  ```

---

## Tag 格式规范

- Tag 顺序：`gorm:"primaryKey;column:xxx;type:xxx;not null;default:xxx;index/uniqueIndex;comment:xxx"`
- 所有字段必须显式指定 `column` 名称
- 核心字段必须包含 `not null`
- 有默认值的字段使用 `default:xxx`
- 所有业务字段必须包含 `comment:xxx` 标签（`id`、`created_at`、`updated_at` 等通用字段可省略）

---

## 索引规范

### 单字段索引
- 普通索引：`index`
- 唯一索引：`uniqueIndex`
- 示例：`gorm:"column:email;type:text;not null;uniqueIndex;comment:邮箱"`

### 联合索引

思维导图中可能使用以下格式标注联合索引：

```
索引: (field1, field2)
唯一索引: (field1, field2, field3)
```

#### 解析规则

1. **识别联合索引标注**：在思维导图的表定义中查找 `索引:` 或 `唯一索引:` 标注
2. **提取字段列表**：解析括号内的字段名，按顺序作为联合索引的列
3. **生成索引名称**：`idx_表名_字段1_字段2` 或 `idx_表名_字段1_字段2_unique`

#### GORM 联合索引语法

使用 `index` 或 `uniqueIndex` 标签，通过 `priority` 指定字段在索引中的顺序：

```go
// 联合索引: (org_id, name)
OrgID string `gorm:"column:org_id;type:bigint;not null;index:idx_role_org_name,priority:1;comment:组织ID"`
Name  string `gorm:"column:name;type:text;not null;index:idx_role_org_name,priority:2;comment:名称"`

// 联合唯一索引: (org_id, code)
OrgID string `gorm:"column:org_id;type:bigint;not null;uniqueIndex:idx_resource_org_code,priority:1;comment:组织ID"`
Code  string `gorm:"column:code;type:text;not null;uniqueIndex:idx_resource_org_code,priority:2;comment:编码"`
```

#### 完整示例

思维导图定义：
```
Resource 资源表
├── org_id: 组织ID
├── code: 编码
├── name: 名称
└── 唯一索引: (org_id, code)
```

生成的模型：
```go
// Resource 资源表
type Resource struct {
	ID        string    `gorm:"primaryKey;column:id;type:bigint"`
	CreatedAt time.Time `gorm:"column:created_at;type:timestamptz;not null;index"`
	UpdatedAt time.Time `gorm:"column:updated_at;type:timestamptz;not null"`
	OrgID     string    `gorm:"column:org_id;type:bigint;not null;uniqueIndex:idx_resource_org_code,priority:1;comment:组织ID"`
	Code      string    `gorm:"column:code;type:text;not null;uniqueIndex:idx_resource_org_code,priority:2;comment:编码"`
	Name      string    `gorm:"column:name;type:text;not null;comment:名称"`
}
```

#### 注意事项

- 联合索引名称必须在所有参与字段上保持一致
- `priority` 值决定字段在索引中的顺序，数值越小越靠前
- 单字段索引使用简写 `index` 或 `uniqueIndex`，联合索引必须指定索引名称
- 一个字段可以同时参与多个索引

---

## 字段排列顺序

1. **身份字段**：`ID`
2. **元数据字段**：`CreatedAt`、`UpdatedAt`
3. **业务字段**：按思维导图中定义的顺序排列（不做额外分组或重排）

---

## TableName 方法

- 必须实现 `TableName() string` 方法
- 返回小写下划线格式的表名
- 使用值接收者：`func (EntityName) TableName() string`

---

## 禁止事项

- 禁止使用 GORM 的外键关联（`foreignKey`、`references`）
- 禁止使用 `gorm.Model` 嵌入（字段命名不符合规范）
- 禁止使用 `serial` 或 `autoIncrement`
- 禁止使用 `varchar(n)` 或 `char(n)`
- 禁止省略 `column` 标签

---

## 模型示例

### 基础业务表
```go
// User 系统用户
type User struct {
	ID        string    `gorm:"primaryKey;column:id;type:bigint"`
	CreatedAt time.Time `gorm:"column:created_at;type:timestamptz;not null;index"`
	UpdatedAt time.Time `gorm:"column:updated_at;type:timestamptz;not null"`
	Email     string    `gorm:"column:email;type:text;not null;uniqueIndex;comment:邮箱地址"` // 邮箱地址
	Phone     string    `gorm:"column:phone;type:text;not null;index;comment:手机号码"`       // 手机号码
	Name      string    `gorm:"column:name;type:text;not null;comment:用户姓名"`              // 用户姓名
	Password  string    `gorm:"column:password;type:text;not null;comment:登录密码"`          // 登录密码
	Avatar    string    `gorm:"column:avatar;type:text;not null;comment:头像地址"`            // 头像地址
	Active    bool      `gorm:"column:active;not null;default:true;comment:是否启用"`         // 是否启用
}

func (User) TableName() string {
	return "user"
}
```

### 带关联的表
```go
// Role 角色
type Role struct {
	ID          string    `gorm:"primaryKey;column:id;type:bigint"`
	CreatedAt   time.Time `gorm:"column:created_at;type:timestamptz;not null;index"`
	UpdatedAt   time.Time `gorm:"column:updated_at;type:timestamptz;not null"`
	OrgID       string    `gorm:"column:org_id;type:bigint;not null;comment:所属组织"`        // 所属组织
	Name        string    `gorm:"column:name;type:text;not null;comment:角色名称"`            // 角色名称
	Description string    `gorm:"column:description;type:text;not null;comment:角色描述"`     // 角色描述
	Sort        int16     `gorm:"column:sort;not null;default:0;comment:排序权重"`            // 排序权重
	Active      bool      `gorm:"column:active;not null;default:true;comment:是否启用"`       // 是否启用
}

func (Role) TableName() string {
	return "role"
}
```

### 关联表（多对多中间表）
```go
// RolePermission 角色权限关联
type RolePermission struct {
	RoleID       string `gorm:"primaryKey;column:role_id;type:bigint;comment:角色ID"`       // 角色ID
	PermissionID string `gorm:"primaryKey;column:permission_id;type:bigint;comment:权限ID"` // 权限ID
}

func (RolePermission) TableName() string {
	return "role_permission"
}
```

---

## GORM 模型检查清单

生成 GORM 模型时，确认：

- [ ] 主键和关联字段使用 `string` 类型 + `type:bigint`（避免 JS 精度丢失）
- [ ] 包含 `CreatedAt` 和 `UpdatedAt` 时间字段（`type:timestamptz`，紧跟在 `ID` 之后）
- [ ] `CreatedAt` 字段包含 `index` 索引
- [ ] 业务字段按思维导图中的顺序排列
- [ ] 表注释和字段注释来自思维导图描述
- [ ] 业务字段包含 `comment:xxx` 标签（数据库级别注释）
- [ ] 文本字段使用 `string` + `type:text`
- [ ] 所有字段显式指定 `column` 名称
- [ ] 核心字段包含 `not null`
- [ ] 联合索引已正确解析（索引名称一致、priority 顺序正确）
- [ ] 实现 `TableName()` 方法返回小写下划线表名
- [ ] 无外键关联定义
- [ ] 无 `gorm.Model` 嵌入

---

# 命令自动化引导

> 本节定义项目中常用命令的执行规则和工作流程，供 LLM 在协助开发时参考。

---

## 环境准备

### 前置依赖

在执行任何命令前，确保以下工具已安装：

- **Go 1.24+**：项目运行时
- **Atlas CLI**：数据库迁移工具
  ```bash
  curl -sSf https://atlasgo.sh | sh
  ```
- **Python 3.10+**：迁移脚本运行时
- **Docker**：Atlas 开发数据库容器

### 配置文件

1. 复制 `.env.example` 为 `.env`
2. 填入实际的数据库连接信息
3. `.env` 文件不应提交到版本控制

---

## 数据库迁移工作流

### 核心命令

所有迁移命令通过 `scripts/migrate.py` 执行：

| 命令 | 用途 | 示例 |
|------|------|------|
| `diff` | 对比模型变更，生成迁移文件 | `scripts/migrate.py diff` |
| `apply` | 应用迁移到数据库 | `scripts/migrate.py apply` |
| `status` | 查看迁移状态 | `scripts/migrate.py status` |
| `inspect` | 查看数据库当前 schema | `scripts/migrate.py inspect` |
| `push` | 直接推送 schema（仅开发环境） | `scripts/migrate.py push` |
| `hash` | 重新生成迁移文件哈希 | `scripts/migrate.py hash` |

### 环境切换

默认使用 `local` 环境，生产环境需显式指定：

```bash
# 本地环境（默认）
scripts/migrate.py diff

# 生产环境
scripts/migrate.py --env prod apply
```

### 模型变更后的标准流程

当 GORM 模型发生变更时，按以下步骤操作：

```bash
# 1. 生成迁移文件
scripts/migrate.py diff

# 2. 检查生成的 SQL（在 migrations/ 目录，人工审核破坏性变更）
cat migrations/*.sql | tail -50

# 3. 应用迁移到本地数据库
scripts/migrate.py apply

# 4. 验证迁移状态
scripts/migrate.py status
```

---

## Atlas Loader 模型注册

当新增模型时，必须在 `cmd/atlas-loader/main.go` 中注册：

```go
models := []any{
    &model.User{},
    &model.Org{},
    // 新增模型在此处添加
    &model.NewEntity{},
}
```

**重要**：未注册的模型不会被 Atlas 识别，迁移时将被忽略。

---

## Go 项目常用命令

### 依赖管理

```bash
# 下载依赖
go mod download

# 整理依赖（移除未使用、添加缺失）
go mod tidy

# 更新特定依赖
go get -u github.com/example/package
```

### 代码生成

```bash
# Wire 依赖注入生成（如使用）
go generate ./...
```

### 运行与测试

```bash
# 运行应用
go run .

# 运行测试
go test ./...

# 带覆盖率的测试
go test -cover ./...
```

---

## 自动化任务清单

LLM 在执行特定任务时，应自动触发相关命令：

### 新增模型后

1. ✅ 在 `cmd/atlas-loader/main.go` 的 `models` 切片中注册模型
2. ✅ 在 `cmd/atlas-loader/main.go` 的 `tableComments` 中添加表注释
3. ✅ 执行 `scripts/migrate.py diff` 生成迁移
4. ✅ 人工审核生成的 SQL 文件
5. ✅ 执行 `scripts/migrate.py apply` 应用迁移

### 修改模型字段后

1. ✅ 执行 `scripts/migrate.py diff` 生成迁移
2. ✅ 人工审核生成的 SQL（特别关注破坏性变更）
3. ✅ 执行 `scripts/migrate.py apply` 应用迁移

### 添加新依赖后

1. ✅ 执行 `go mod tidy` 整理依赖

---

## 危险操作警告

以下操作需要用户明确确认：

- ⚠️ `--env prod` 任何生产环境操作
- ⚠️ 删除列或表的迁移（数据丢失风险）
- ⚠️ 修改列类型（可能导致数据转换失败）
- ⚠️ 删除索引（可能影响查询性能）

执行前必须：
1. 明确告知用户操作风险
2. 等待用户确认
3. 建议先在本地环境验证

---

## 常见问题处理

### 迁移冲突

如果迁移文件哈希不匹配：

```bash
# 重新计算哈希
scripts/migrate.py hash
```

### Atlas 命令未找到

```bash
# 安装 Atlas CLI
curl -sSf https://atlasgo.sh | sh
```

### 表注释维护

表注释通过 `cmd/atlas-loader/main.go` 中的 `tableComments` 映射管理：

```go
var tableComments = map[string]string{
    "user": "用户表",
    "org":  "组织表",
    // 新增表时在此添加注释
}
```

新增模型时，需同时在 `models` 切片和 `tableComments` 映射中添加对应条目。
