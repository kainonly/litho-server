# PostgreSQL 工程实践规范

> 本文档整理自内部工程约束规范及 PostgreSQL 官方 Wiki 反模式指南，供 LLM 在生成 SQL 或数据库设计时参考。

---

## 命名规范

- 表名、字段名：小写字母 + 下划线，禁止大写（PostgreSQL 会将未加引号的标识符转为小写）
- 逻辑表名不含数字；分区/分表仅体现在物理表层级
- 关联字段：`${entity}_id` 格式，如 `user_id`, `role_id`
- 层级自关联：使用 `pid` 表示父级

---

## 主键与标识符

- 所有业务表必须包含 `id` 字段作为全局唯一标识
- 使用应用程序生成的有序 ID（如 Sonyflake），禁止随机 UUID
- 主键与关联字段统一采用 `bigint`
- 分区表主键需包含分区键：`PRIMARY KEY (date, id)`
- 新项目禁止使用 `serial`，使用 `IDENTITY` 列

---

## 数据类型选择

### 时间类型
- 时间点：`${any}_at` 后缀，类型 `timestamptz`（禁止无时区的 `timestamp`）
- 业务日期：`${any}_date` 后缀，类型 `date`
- 禁止使用 `timetz` 和 `CURRENT_TIME`
- 使用 `now()` 或 `CURRENT_TIMESTAMP` 获取当前时间

### 文本类型
- 禁止使用 `char(n)`（会补空格，比较行为异常）
- 禁止默认使用 `varchar(n)`（与 `text` 存储相同但有不必要的长度限制）
- 推荐使用 `text` + `CHECK` 约束

### 数值类型
- 禁止使用 `money` 类型，使用 `numeric` 或 `integer + 缩放`

### 编码
- 禁止使用 `SQL_ASCII` 编码，推荐 `UTF8`

---

## 状态与控制字段

- 启用/禁用：简单场景用 `active:boolean`
- 业务流转状态：`state:smallint`，状态值从 1 开始，负值表示不可用/异常
- 核心字段应使用 `NOT NULL`，仅在明确允许"未知/未设置"时使用 `NULL`

---

## 字段分组建议

1. **身份与边界**：`id`, `*_id`, 业务唯一键, 分区键
2. **元数据**：`created_at`, `updated_at`
3. **业务核心数据**：`total`, `amount` 等
4. **业务状态/控制字段**：`state`, `active` 等

---

## 约束与索引

- 禁止定义外键、存储过程、触发器等强耦合机制
- 数据一致性以应用层为主
- 允许使用 `CHECK` 等轻量级约束保障数据基本合法性
- 编码类字段仅用于展示，不作为主关联键

---

## 时间戳维护

- 附属表按需维护自身时间字段
- 审计日志/事件流可不额外维护更新时间
- 更新附属表不应级联更新主表的 `updated_at`

---

## 事务使用规范

### 何时使用显式事务
- 多表写入
- 状态流转
- 库存/余额变更
- 禁止依赖 ORM 的隐式事务

### 事务中禁止的操作
- HTTP/RPC/MQ 网络调用
- 文件 IO
- sleep、随机数、外部系统依赖等非确定性操作

### 事务时长
- 单个事务应尽可能短，禁止长事务（> 1s）
- 长事务危害：阻塞 VACUUM、膨胀表与索引、放大锁冲突、增加回滚成本

### 隔离级别
- 默认使用 `READ COMMITTED`
- 仅在明确理解并验证后使用 `REPEATABLE READ` / `SERIALIZABLE`

### 锁与并发
- 禁止使用 `SELECT ... FOR UPDATE` 作为"逻辑锁"
- 正确方式：状态字段 + 条件更新

### 幂等性
- 所有写操作必须幂等，允许事务失败后安全重试
- 推荐：状态机、业务唯一键、`INSERT ... ON CONFLICT`

### 原子操作
- 禁止「先查后写」的非原子逻辑，必须合并为单条原子 SQL
- 计数/余额/库存等数值变更必须使用数据库原子操作，禁止应用层计算后回写

### 时间函数
- 禁止在事务中多次使用 `NOW()` / `CURRENT_TIMESTAMP` 作为业务判断依据
- 应在事务开始时获取一次并复用

### 跨系统一致性
- 采用最终一致性模型（Outbox / MQ / 补偿）
- 禁止使用"分布式事务"

---

## SQL 反模式

### 禁止使用 `NOT IN`
原因：
- 列表中有 `NULL` 时结果可能全为空
- 不会优化成 anti-join，性能极差

替代写法：
```sql
SELECT * FROM foo 
WHERE NOT EXISTS (SELECT 1 FROM bar WHERE foo.col = bar.x);
```

### 禁止使用 `BETWEEN`（尤其是时间戳）
原因：包含边界点，查询时间段可能多算或漏算

替代写法：
```sql
WHERE ts >= '2024-01-01' AND ts < '2024-01-08'
```

### 禁止使用 Rules（规则）
原因：通过查询重写实现，行为不符合预期

替代：使用触发器（trigger）

### 禁止使用表继承（Table Inheritance）
原因：行为不符合 OO 预期，已有原生分区功能替代

---

## 快速检查清单

生成 PostgreSQL 相关代码时，确认：

- [ ] 表名、字段名全小写 + 下划线
- [ ] 主键使用 `bigint` + 应用生成的有序 ID
- [ ] 时间字段使用 `timestamptz`
- [ ] 文本字段使用 `text` 而非 `char(n)` / `varchar(n)`
- [ ] 无外键、存储过程、触发器
- [ ] 事务内无网络调用、文件 IO
- [ ] 数值变更使用原子操作
- [ ] 使用 `NOT EXISTS` 而非 `NOT IN`
- [ ] 时间范围查询使用 `>=` 和 `<` 而非 `BETWEEN`
- [ ] 写操作具备幂等性

---

## GORM 模型生成规范

### 基本结构

所有模型必须遵循以下结构模板：

```go
package model

import "time"

// EntityName 实体注释（来自思维导图）
type EntityName struct {
	ID        string    `gorm:"primaryKey;column:id;type:bigint"`
	CreatedAt time.Time `gorm:"column:created_at;type:timestamptz;not null"`
	UpdatedAt time.Time `gorm:"column:updated_at;type:timestamptz;not null"`
	// 业务字段按思维导图中的顺序排列...
	FieldName string `gorm:"column:field_name;type:text;not null"` // 字段注释（来自思维导图）
}

func (EntityName) TableName() string {
	return "entity_name"
}
```

### 注释规范

- **表注释**：在 `type` 声明上方添加注释，内容来自思维导图中的表/实体描述
- **字段注释**：在字段行尾添加注释，内容来自思维导图中的字段描述
- 注释必须保留思维导图中的原始描述，不得省略或修改

### 字段定义规则

#### 主键
- 必须使用 `ID string` 作为主键（使用 `string` 是因为 JavaScript 无法安全处理超过 `Number.MAX_SAFE_INTEGER` 的整数）
- Tag 格式：`gorm:"primaryKey;column:id;type:bigint"`
- 数据库存储为 `bigint`，Go 层使用 `string` 自动转换

#### 时间字段
- 必须包含 `CreatedAt` 和 `UpdatedAt`
- 类型：`time.Time`
- 必须显式指定 `type:timestamptz`（GORM 默认使用 `timestamp without time zone`，不符合规范）
- Tag 格式：`gorm:"column:created_at;type:timestamptz;not null"`

#### 关联字段（逻辑外键）
- 命名格式：`${Entity}ID`，如 `OrgID`、`UserID`
- 类型：`string`（与主键保持一致，避免前端精度丢失）
- 列名格式：`${entity}_id`，如 `org_id`、`user_id`
- Tag 格式：`gorm:"column:org_id;type:bigint;not null"`
- 层级自关联使用 `PID string` + `gorm:"column:pid;type:bigint"`

#### 文本字段
- 类型：`string`
- 必须显式指定 `type:text`
- 示例：`gorm:"column:name;type:text;not null"`

#### 布尔字段
- 启用/禁用统一使用 `Active bool`
- 必须指定默认值：`gorm:"column:active;not null;default:true"`

#### 状态字段
- 业务流转状态使用 `State int16`
- 状态值从 1 开始，负值表示异常

#### 排序字段
- 使用 `Sort int16`
- 默认值为 0：`gorm:"column:sort;not null;default:0"`

#### JSONB 字段
- 对象类型：使用 `common.M`（`map[string]any`）
- 数组类型：使用 `common.A`（`[]any`），适用于数组或数组对象
- Tag 格式：`gorm:"column:xxx;type:jsonb;not null;default:'{}'"`（对象）或 `default:'[]'`（数组）
- 示例：
  ```go
  Metadata common.M `gorm:"column:metadata;type:jsonb;not null;default:'{}'"`
  Tags     common.A `gorm:"column:tags;type:jsonb;not null;default:'[]'"`
  ```

### Tag 格式规范

- Tag 顺序：`gorm:"primaryKey;column:xxx;type:xxx;not null;default:xxx;index/uniqueIndex"`
- 所有字段必须显式指定 `column` 名称
- 核心字段必须包含 `not null`
- 有默认值的字段使用 `default:xxx`

### 字段排列顺序

1. **身份字段**：`ID`
2. **元数据字段**：`CreatedAt`、`UpdatedAt`
3. **业务字段**：按思维导图中定义的顺序排列（不做额外分组或重排）

### TableName 方法

- 必须实现 `TableName() string` 方法
- 返回小写下划线格式的表名
- 使用值接收者：`func (EntityName) TableName() string`

### 禁止事项

- 禁止使用 GORM 的外键关联（`foreignKey`、`references`）
- 禁止使用 `gorm.Model` 嵌入（字段命名不符合规范）
- 禁止使用 `serial` 或 `autoIncrement`
- 禁止使用 `varchar(n)` 或 `char(n)`
- 禁止省略 `column` 标签

### 模型示例

#### 基础业务表
```go
// User 系统用户
type User struct {
	ID        string    `gorm:"primaryKey;column:id;type:bigint"`
	CreatedAt time.Time `gorm:"column:created_at;type:timestamptz;not null"`
	UpdatedAt time.Time `gorm:"column:updated_at;type:timestamptz;not null"`
	Email     string    `gorm:"column:email;type:text;not null;uniqueIndex"` // 邮箱地址
	Phone     string    `gorm:"column:phone;type:text;not null;index"`       // 手机号码
	Name      string    `gorm:"column:name;type:text;not null"`              // 用户姓名
	Password  string    `gorm:"column:password;type:text;not null"`          // 登录密码
	Avatar    string    `gorm:"column:avatar;type:text;not null"`            // 头像地址
	Active    bool      `gorm:"column:active;not null;default:true"`         // 是否启用
}

func (User) TableName() string {
	return "user"
}
```

#### 带关联的表
```go
// Role 角色
type Role struct {
	ID          string    `gorm:"primaryKey;column:id;type:bigint"`
	CreatedAt   time.Time `gorm:"column:created_at;type:timestamptz;not null"`
	UpdatedAt   time.Time `gorm:"column:updated_at;type:timestamptz;not null"`
	OrgID       string    `gorm:"column:org_id;type:bigint;not null"`        // 所属组织
	Name        string    `gorm:"column:name;type:text;not null"`            // 角色名称
	Description string    `gorm:"column:description;type:text;not null"`     // 角色描述
	Sort        int16     `gorm:"column:sort;not null;default:0"`            // 排序权重
	Active      bool      `gorm:"column:active;not null;default:true"`       // 是否启用
}

func (Role) TableName() string {
	return "role"
}
```

#### 关联表（多对多中间表）
```go
// RolePermission 角色权限关联
type RolePermission struct {
	RoleID       string `gorm:"primaryKey;column:role_id;type:bigint"`       // 角色ID
	PermissionID string `gorm:"primaryKey;column:permission_id;type:bigint"` // 权限ID
}

func (RolePermission) TableName() string {
	return "role_permission"
}
```

### GORM 模型检查清单

生成 GORM 模型时，确认：

- [ ] 主键和关联字段使用 `string` 类型 + `type:bigint`（避免 JS 精度丢失）
- [ ] 包含 `CreatedAt` 和 `UpdatedAt` 时间字段（`type:timestamptz`，紧跟在 `ID` 之后）
- [ ] 业务字段按思维导图中的顺序排列
- [ ] 表注释和字段注释来自思维导图描述
- [ ] 文本字段使用 `string` + `type:text`
- [ ] 所有字段显式指定 `column` 名称
- [ ] 核心字段包含 `not null`
- [ ] 实现 `TableName()` 方法返回小写下划线表名
- [ ] 无外键关联定义
- [ ] 无 `gorm.Model` 嵌入
